name: Big Data Pipeline Integration Test

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  integration-test:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Setup Environment
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v1

    # 2. Generate Dummy Data
    - name: Generate Dummy Test Data
      run: |
        mkdir -p data
        uv venv .venv
        uv pip install pandas numpy pyarrow
        
        # Simple script to generate valid parquet
        uv run python -c "
        import pandas as pd
        import numpy as np
        import pyarrow as pa
        import pyarrow.parquet as pq
        
        # Define the number of minutes in 3 days
        num_periods = 3 * 24 * 60  # 4320 rows
        
        df = pd.DataFrame({
            'VendorID': [1, 2] * (num_periods // 2),
            'tpep_pickup_datetime': pd.date_range(start='2025-08-01', periods=num_periods, freq='min'),
            'tpep_dropoff_datetime': pd.date_range(start='2025-08-01 00:10:00', periods=num_periods, freq='min'),
            'passenger_count': np.random.randint(1, 5, num_periods),
            'trip_distance': np.random.rand(num_periods) * 10,
            'PULocationID': np.random.randint(1, 263, num_periods),
            'DOLocationID': np.random.randint(1, 263, num_periods),
            'total_amount': np.random.rand(num_periods) * 50
        })
        table = pa.Table.from_pandas(df)
        pq.write_table(table, 'data/yellow_tripdata_2025-08.parquet')
        print('Dummy parquet generated successfully.')
        "

    # 3. Start Infrastructure
    - name: Start Docker Services
      run: docker compose up -d

    # 4. Run Integration Test
    - name: Run Integration Test
      run: |
        uv pip install cassandra-driver
        
        echo "Running Integration Test Script..."
        .venv/bin/python tests/integration_test.py

    # 5. Cleanup / Logs
    - name: Dump Docker Logs on Failure
      if: failure()
      run: docker compose logs
